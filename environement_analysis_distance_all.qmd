---
title: "Qualifier les signalements de piq√ªres de tiques par analyses multivari√©es des donn√©es paysag√®res"
subtitle: "Analyse multivari√©e des paysages de piq√ªres de tiques avec CLC 2018"
author: "Djibril, Lucas, Samuel"

format:
  html:
    toc: true
    toc-depth: 2
    toc-title: "Sommaire"
    toc-location: left      # ‚Üê arborescence √† gauche
    toc-expand: true        # optionnel : d√©plie les sections
    number-sections: true
    code-fold: show
    code-tools: true
    theme: cosmo
    highlight-style: github
    fig-width: 10
    fig-height: 8
    self-contained: true
    callout-icon: false
execute:
  warning: false
  message: false
  echo: false

editor: 
  markdown: 
    wrap: 72
---

**Introduction**

::: {.callout-important title="Contexe de l'√©tude"}

En France m√©tropolitaine, les maladies vectorielles transmises par les tiques, et en particulier la borr√©liose de Lyme, constituent un enjeu croissant de sant√© publique. Entre 2019 et 2020, l‚Äôincidence de cette pathologie a augment√© de 20 %, atteignant plus de 60 000 cas annuels diagnostiqu√©s **(CRMVT Paris-R√©gion Nord)**. 

Cette √©volution est √©troitement li√©e aux effets du changement climatique, qui modifient les conditions bioclimatiques favorables au d√©veloppement de la tique Ixodes ricinus, entra√Ænant une extension spatiale de son aire de distribution et une prolongation de sa p√©riode d‚Äôactivit√© sur le territoire m√©tropolitain **(INRAE - Projet Climatick, 2024).**

Dans ce contexte, ce travail vise √† caract√©riser spatialement les ¬´ paysages de piq√ªre ¬ª afin d‚Äôapprofondir la compr√©hension de l‚Äô√©cologie spatiale des tiques. L‚Äôobjectif est d‚Äôidentifier et de cartographier des profils paysagers associ√©s aux zones de forte exposition.

L‚Äô√©tude repose sur l‚Äôexploitation de la base de donn√©es Corine Land Cover (CLC) au sein d‚Äôun syst√®me d‚Äôinformation g√©ographique (SIG), permettant l‚Äôextraction de m√©triques d‚Äôoccupation du sol dans des buffers optimis√©s autour des points de signalement de piq√ªres. 

L‚Äôapplication de m√©thodes d‚Äôanalyse multivari√©e conduit √† la d√©finition de typologies paysag√®res, offrant une confrontation objective entre les paysages analys√©s et les milieux d√©clar√©s, et contribuant ainsi √† une meilleure compr√©hension spatiale de l‚Äô√©cologie des tiques.

:::
# D√©termination de l'emprise optimale autour de point de piq√ªre

##configuration de workspace

```{r eval=FALSE}
library(reticulate)

py_require("pandas", action = "add")

py_require("matplotlib", action = "add")

py_require("seaborn", action = "add")

py_require("jupyter", action = "add")

py_require("geopandas", action = "add")


```

```{python}
import pandas as pd
import geopandas as gpd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
```

## Nettoyage de donn√©es

**Chargement de donn√©es CSV**

```{python}
## Lecture
df = pd.read_csv('../inputs/distance_chats-chiens_export_temp_v4.csv', sep=";", header=0, encoding='latin1')
#print(df.head())
```

**Conversion des types de variables "object" avec #N/D en float64**

```{python}
#import numpy as np

# Remplacer les '#N/D' par NaN (optionnel si les valeurs ne sont pas reconnues automatiquement)
#df['lat_dom'] = df['lat_dom'].replace('#N/D', np.nan) # semble optionnel

# Convertir en float64
df['lat_dom'] = pd.to_numeric(df['lat_dom'], errors='coerce')
df['lon_dom'] = pd.to_numeric(df['lon_dom'], errors='coerce')
df['distance(km)'] = pd.to_numeric(df['distance(km)'], errors='coerce')
df['code_postal'] = pd.to_numeric(df['code_postal'], errors='coerce').astype('Int64')

```

**V√©rifier les types de variables**

```{python}
print(df.dtypes)
```

**Correction de la variable 'environnement'**

```{python}
# Correction de la colonne 'environnement'
df['environnement'] = df['environnement'].str.strip()  # supprimer les espaces en d√©but/fin

# Remplacer les valeurs vides ou nulles par 'Autre'
df['environnement'] = df['environnement'].replace(["''", None], 'Autre')

# Uniformiser les doublons / variations de texte
df['environnement'] = df['environnement'].replace({
    'Jardin priv√©': 'Jardin priv√© ou parc municipal',
    'Jardin Priv√©': 'Jardin priv√© ou parc municipal',
    'Jardin priv√© ou parc municipal': 'Jardin priv√© ou parc municipal',
    'Prairie': 'Prairie',
    'Parc urbain': 'Jardin priv√© ou parc municipal',
    'Zone agricole cultiv√©e': 'Zone agricole cultiv√©e',
    'For√™t': 'For√™t',
    'Autre': 'Autre'
})

# V√©rifier le r√©sultat
print(df['environnement'].value_counts())
```

**S√©lection des enregistrements pour les chiens**

```{python}
## Filtrage sur le donn√©es de chien
df_dog = df[df['qui_pique'] == 'Chien']
df_dog.shape
```

**Compte des valeurs non manquantes par colonne**

```{python}
# Compte des valeurs non manquantes par colonne
nb_enregistrements_par_col = df_dog.count()
print(nb_enregistrements_par_col)
```

## Distance moyenne entre domicile et lieu des piq√ªres pour les chiens

**Extraction des distances pour les chiens**

```{python}
## Extraire les distances pour les chiens

dist_chiens = df_dog.loc[df['qui_pique'] == 'Chien', 'distance(km)'].dropna()


## Calcul des d√©ciles

deciles_chiens = np.percentile(dist_chiens, np.arange(0, 110, 10))

# Arrondi √† 2 chiffre d√©cimal

deciles_chiens = np.round(deciles_chiens, 2)

# Cr√©ation d'un DataFrame pour le tableau
tableau_deciles = pd.DataFrame({
    'Percentile (%)': np.arange(0, 110, 10),
    'Distance (km)': deciles_chiens
})

print(tableau_deciles)
```

::: {.callout-tip title="Analyse de la distribution des distances moyennes"}
L‚Äôanalyse des percentiles de la distance moyenne met en √©vidence une distribution fortement asym√©trique √† droite. La majorit√© des observations correspond √† des distances tr√®s courtes : la m√©diane est de 0,83 km et 70 % des distances sont inf√©rieures √† 2,36 km. Cette concentration pr√®s de z√©ro indique que le comportement dominant est celui de d√©placements de courte port√©e.

En revanche, la pr√©sence de valeurs tr√®s √©lev√©es dans la partie sup√©rieure de la distribution entra√Æne un √©talement important. Alors que le 90·µâ percentile atteint seulement 7,72 km, la valeur maximale observ√©e s‚Äô√©l√®ve √† 834,19 km, r√©v√©lant l‚Äôexistence de cas rares et extr√™mes.

Ces valeurs extr√™mes influencent fortement la moyenne, qui devient peu repr√©sentative de la distance typique parcourue. Dans ce contexte, l‚Äôutilisation de la m√©diane et des percentiles appara√Æt plus pertinente pour d√©crire le comportement central de la population √©tudi√©e.
:::

**Comparaison de la distance moyenne sur 10 d√©ciles et les 9 premiers d√©ciles**

```{python}
## Moyenne de la distance totale pour les chiens

moyenne_chiens_10D = df_dog.loc[df_dog['qui_pique'] == 'Chien', 'distance(km)'].mean()

## Moyenne de la distance sur les 9 premiers d√©ciles pour les chiens

# 1. Calcul du 9e d√©cile
neuvieme_decile = np.percentile(dist_chiens, 90)

# 2. Calcul de la moyenne sur les 9 premiers d√©ciles
moyenne_chiens_9D = df_dog.loc[df_dog['distance(km)'] <= neuvieme_decile, 'distance(km)'].mean()

print(f"Moyenne distance pour chiens (10 d√©ciles) : {round(moyenne_chiens_10D,3)} km")
print(f"Moyenne distance pour chiens (9 d√©ciles) : {round(moyenne_chiens_9D,3)} km")

```

::: {.callout-tip title="Synth√®se de distances moyennes"}
La comparaison des distances moyennes calcul√©es sur l‚Äôensemble des d√©ciles et sur les neuf premiers d√©ciles met en √©vidence une diff√©rence substantielle. La distance moyenne incluant l‚Äôensemble des observations s‚Äô√©l√®ve √† 8,419 km, tandis que celle calcul√©e apr√®s exclusion du dixi√®me d√©cile est limit√©e √† 1,383 km.

Cet √©cart marqu√© r√©v√®le une forte sensibilit√© de la moyenne aux valeurs extr√™mes. En effet, les observations appartenant au dixi√®me d√©cile, correspondant aux 10 % de distances les plus √©lev√©es, exercent une influence disproportionn√©e sur la valeur moyenne globale.

Ces r√©sultats confirment l‚Äôexistence d‚Äôune distribution fortement asym√©trique, domin√©e par une majorit√© d‚Äôobservations de faible amplitude et une minorit√© de valeurs exceptionnellement √©lev√©es.

Ainsi, les distances associ√©es aux neuf premiers d√©ciles apparaissent relativement homog√®nes et refl√®tent plus fid√®lement le comportement typique de la population √©tudi√©e.

Compte tenu de l‚Äôinfluence disproportionn√©e du dernier d√©cile sur la moyenne, nous privil√©gions la moyenne tronqu√©e aux 90% pour calculer rayon de 1.383 km autour de signalements des piqures de tique sur les chiens en France m√©tropolitaine.
:::

## Geotraitement de donn√©es de signalements

**Cr√©ation du GeoDataFrame avec g√©om√©trie**

```{python}
gdf_dog = gpd.GeoDataFrame(
    df_dog,
    geometry=gpd.points_from_xy(df_dog['lon_piq'], df_dog['lat_piq']),
    crs="EPSG:4326"
)
```

**Reprojection du GeoDataFrame en Lambert-93**

```{python}

gdf_dog_l93=gdf_dog.to_crs('EPSG:2154')
```

**Cr√©ation de zone tampon de 1.300 km**

```{python}
# cr√©ation de la nouvelle colonne (rayon)
gdf_dog_l93['rayon_m']=gdf_dog_l93.buffer(1300)
```

## Conversion de points en polygons

**D√©finir rayon_m comme g√©om√©trie principale**

```{python}
gdf_dog_l93['geometry'] = gdf_dog_l93['rayon_m']
```

**V√©rification**

```{python}
print(gdf_dog_l93.geometry.head())
print(gdf_dog_l93.geom_type.unique())

```

**Suppression de la colonne rayon_m**

```{python}
#  
gdf_dog_l93 = gdf_dog_l93.drop(columns='rayon_m')
```

**Verifier les valeurs non maquantes**

```{python}
gdf_dog_l93.count()
```

## Export en format shapefile

**Renommer les colonnes avant export (pour rester lisible)**

```{python}
gdf_dog_l93 = gdf_dog_l93.rename(columns={
    'distance(km)': 'dist_km',
    'date_piqure_saisie': 'date_piq',
    'precision_geo': 'precision',
    'environnement': 'environ',
    'code_postal': 'code_post',
    'temperaturemin': 'temp_min',
    'temperaturemax': 'temp_max'
})
```

**Definition de dossier de sauvegarde**

```{python}
outputs='../outputs/rayon_chiens_1300m.shp'
```

**Sauvergarde en format SHP**

```{python}
gdf_dog_l93.to_file(outputs, driver='ESRI Shapefile')
```


# Analyse multivari√©e de l'occupation du sol

## Installation et chargement des packages

```{r setup}
# Liste des packages n√©cessaires
pkgs <- c(
  "sf", "terra", "exactextractr", "FactoMineR", "cluster",
  "factoextra", "dplyr", "tidyr", "ggplot2", "tmap",
  "knitr", "patchwork"
)

# Installation automatique si n√©cessaire
to_install <- setdiff(pkgs, rownames(installed.packages()))
if (length(to_install)) {
  install.packages(to_install, repos = "https://cloud.r-project.org")
}

# Chargement des biblioth√®ques
library(sf)
library(terra)
library(exactextractr)
library(FactoMineR)
library(factoextra)
library(cluster)
library(dplyr)
library(tidyr)
library(ggplot2)
library(tmap)
library(knitr)
library(patchwork)
```

## Chargement du raster CLC+ (EPSG:3035)

```{r load-raster}
# Chemin vers le raster
raster_path <- "C:/Users/geographie/Documents/Master-G2M/M2-G2M/Ptut_VG_B/processing/inputs/CLCplus_2018_010m.tif"
raster_clc <- rast(raster_path)

# D√©finition WKT pour EPSG:3035 (ETRS89 / LAEA Europe)
wkt3035 <- 'PROJCRS["ETRS89-extended / LAEA Europe",
  BASEGEOGCRS["ETRS89",
    DATUM["European Terrestrial Reference System 1989",
      ELLIPSOID["GRS 1980",6378137,298.257222101]],
    PRIMEM["Greenwich",0]],
  CONVERSION["Lambert Azimuthal Equal Area",
    METHOD["Lambert Azimuthal Equal Area"],
    PARAMETER["Latitude of natural origin",52],
    PARAMETER["Longitude of natural origin",10],
    PARAMETER["False easting",4321000],
    PARAMETER["False northing",3210000]],
  CS[Cartesian,2],
    AXIS["easting (X)",east],
    AXIS["northing (Y)",north],
    LENGTHUNIT["metre",1],
  ID["EPSG",3035]]'

# Assigner la projection si manquante
if (is.na(crs(raster_clc)) || crs(raster_clc) == "") {
  crs(raster_clc) <- wkt3035
}

# V√©rifications
cat("üìä R√©solution:", res(raster_clc), "m\n")
cat("üó∫Ô∏è  Projection:", as.character(crs(raster_clc, proj = TRUE)), "\n")
```

## Chargement de points signalement de piqure de tique sur le chien

```{r load-signalements}
# Lecture du shapefile des signalements
signalements <- st_read("C:/Users/geographie/Documents/Master-G2M/M2-G2M/Ptut_VG_B/processing/outputs/rayon_chiens_1300m.shp", quiet = TRUE)

# Reprojection vers EPSG:3035 si n√©cessaire
if (st_crs(signalements) != crs(raster_clc)) {
  signalements <- st_transform(signalements, crs(raster_clc))
}

cat("üèòÔ∏è  Nombre de signalements:", nrow(signalements), "\n")
```

## Extraction des statistiques par signalements

Extraction du pourcentage de chaque classe CLC+ par signalements avec
`exactextractr`.

```{r extract-stats}
results_df <- exactextractr::exact_extract(
  raster_clc,
  signalements,
  fun = function(values, coverage_fractions) {
    # Cr√©ation d'un dataframe valeurs √ó poids
    df <- data.frame(val = values, w = coverage_fractions)

    # Filtrer uniquement les classes CLC+ valides (1-11)
    df <- df[!is.na(df$val) & df$val %in% 1:11, ]

    # Si aucune donn√©e, retourner des z√©ros
    if (nrow(df) == 0) return(rep(0, 11))

    # Agr√©ger par classe et calculer les pourcentages
    agg <- aggregate(w ~ val, df, sum)
    pct <- numeric(11)
    pct[agg$val] <- 100 * agg$w / sum(agg$w)

    return(pct)
  },
  progress = FALSE
)
```

## Assemblage des r√©sultats

```{r assemble-results}
# V√©rifier si transposition n√©cessaire
if (is.matrix(results_df) &&
    nrow(results_df) == 11 &&
    ncol(results_df) == nrow(signalements)) {
  results_df <- t(results_df)
}

# Conversion en data.frame
results_df <- as.data.frame(results_df)
colnames(results_df) <- paste0("class_", 1:11)
rownames(results_df) <- NULL

# V√©rification des dimensions
stopifnot(nrow(results_df) == nrow(signalements))

# Fusion avec les donn√©es communales
signalements_clc <- dplyr::bind_cols(signalements, results_df)

# Aplatissement des colonnes si n√©cessaire (format liste)
class_cols <- paste0("class_", 1:11)
for (cc in class_cols) {
  x <- signalements_clc[[cc]]
  if (is.list(x)) x <- unlist(x, recursive = TRUE, use.names = FALSE)
  x <- suppressWarnings(as.numeric(x))
  if (length(x) < nrow(signalements_clc)) {
    x <- rep_len(x, nrow(signalements_clc))
  }
  signalements_clc[[cc]] <- x
}

cat("‚úÖ Extraction termin√©e pour", nrow(signalements_clc), "signalements\n")
```

## Taux de couverture moyenne par clc

```{r}
clc_labels <- c(
  "Surfaces arti.",
  "Feuillus",
  "Conif√®res",
  "For√™ts mixtes",
  "Arbustive/herbac√©e",
  "Prairies",
  "Cultures",
  "Zones humides int.",
  "Zones humides c√¥t.",
  "Plans d'eau",
  "Espaces marins"
)
```


```{r stats-global}
library(sf)
library(dplyr)
library(knitr)
library(kableExtra)

# ‚îÄ‚îÄ Labels CLC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
clc_labels <- c(
  "1. Surfaces artificialis√©es",
  "2. For√™ts de feuillus",
  "3. For√™ts de conif√®res",
  "4. For√™ts mixtes",
  "5. V√©g√©tation arbustive/herbac√©e",
  "6. Prairies",
  "7. Terres arables / Cultures",
  "8. Zones humides int√©rieures",
  "9. Zones humides c√¥ti√®res",
  "10. Plans d'eau",
  "11. Espaces marins"
)

# ‚îÄ‚îÄ Calcul des moyennes par classe CLC (%) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
moyennes_vec <- signalements_clc |>
  st_drop_geometry() |>
  select(starts_with("class_")) |>
  summarise(across(everything(), ~ mean(.x, na.rm = TRUE))) |>
  unlist(use.names = FALSE)

# ‚îÄ‚îÄ V√©rification de coh√©rence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
stopifnot(length(moyennes_vec) == length(clc_labels))

# ‚îÄ‚îÄ Tableau final ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
df_tab <- tibble::tibble(
  Classe  = clc_labels,
  Moyenne = round(moyennes_vec, 2)
)

# ‚îÄ‚îÄ Tableau stylis√© (tri d√©croissant) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
df_tab |>
  arrange(desc(Moyenne)) |>
  kable(
    align = c("l", "r"),
    col.names = c("Type d'occupation du sol", "Moyenne (%)"),
    caption = "üìà Statistiques moyennes par classe CLC"
  ) |>
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "left",
    font_size = 14
  ) 
```

::: {.callout-tip title="Analyse de taux de couverture par classe CLC 2018"}
L'analyse de la r√©partition moyenne des classes d'occupation du sol dans
les rayon de 1,3 km autour de point de signalement de piq√ªre de tique
r√©v√®le trois points majeurs :

-   Dominance des milieux ouverts et forestiers : Le territoire est
    majoritairement marqu√© par les for√™ts de conif√®res (29,48 %) et les
    prairies (25,75 %). √Ä elles seules, ces deux classes repr√©sentent
    plus de la moiti√© de la surface moyenne √©tudi√©e, sugg√©rant un
    paysage √† forte composante naturelle ou semi-naturelle.

-   Empreinte humaine significative : Les activit√©s humaines occupent
    une place importante avec un √©quilibre quasi parfait entre les
    terres arables/cultures (16,51 %) et les surfaces artificialis√©es
    (16,30 %). Ce taux d'artificialisation est relativement √©lev√©,
    indiquant une pr√©sence urbaine notable.

-   Marginalit√© des milieux humides et mixtes : Les zones humides
    (int√©rieures et c√¥ti√®res), les espaces marins et les for√™ts mixtes
    sont quasi absents ou tr√®s localis√©s (proches de 0 %). De m√™me, les
    for√™ts de feuillus (7,66 %) sont nettement moins repr√©sent√©es que
    les conif√®res, ce qui peut refl√©ter une sp√©cificit√© biog√©ographique
    ou une gestion foresti√®re cibl√©e.

-   Grossomodo, il s'agit d'un territoire contrast√©, domin√© par un duo
    "Conif√®res-Prairies", mais soumis √† une pression anthropique
    (urbaine et agricole) qui couvre un tiers de la surface totale.
:::

**Conversion de polygon vers point**

```{r}
signalements_clc <- suppressWarnings(
  signalements_clc %>% st_centroid()
)

```

## Analyse en Composantes Principales (ACP)

### Calcul de l'ACP

```{r pca-compute}
# Extraction des donn√©es pour l'ACP (sans g√©om√©trie)
data_pca <- signalements_clc %>%
  st_drop_geometry() %>%
  select(all_of(class_cols))

# ACP avec centrage et r√©duction
pca_res <- PCA(data_pca, scale.unit = TRUE, graph = FALSE)

# R√©sum√© de la variance expliqu√©e
cat("üîç Variance expliqu√©e par les 5 premiers axes (%):\n")
print(round(pca_res$eig[1:5, 2], 2))
cat("\nüìä Variance cumul√©e (5 axes):",
    round(pca_res$eig[5, 3], 2), "%\n")

```

## √âboulis des valeurs propres

```{r pca-scree}
p_scree <- fviz_eig(
  pca_res,
  addlabels = TRUE,
  barfill = "#2E86AB",
  barcolor = "#1B4F72",
  linecolor = "grey40",
  ncp = 7,
  main = "√âboulis des valeurs propres",
  xlab = "Composante principale",
  ylab = "% de variance expliqu√©e"
)
print(p_scree)

```

### Cercle des corr√©lations

```{r}
# Tes labels sans cl√©s
clc_labels <- c(
  "Surfaces arti.",
  "Feuillus",
  "Conif√®res",
  "For√™ts mixtes",
  "Arbustive/herbac√©e",
  "Prairies",
  "Cultures",
  "Zones humides int.",
  "Zones humides c√¥t.",
  "Plans d'eau",
  "Espaces marins"
)

# üîÑ 1. Remplacer les noms des variables dans les r√©sultats PCA
colnames(pca_res$var$coord)   # juste pour v√©rifier
rownames(pca_res$var$coord) <- clc_labels
rownames(pca_res$var$contrib) <- clc_labels
rownames(pca_res$var$cos2)    <- clc_labels

# üîµ 2. Tracer le cercle des corr√©lations
p_circle <- fviz_pca_var(
  pca_res,
  col.var = "contrib",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE,
  title = "Cercle des corr√©lations (axes 1 et 2)"
)

print(p_circle)

```

### Contributions des variables

```{r pca-contrib, fig.width=12, fig.height=5}
p_contrib1 <- fviz_contrib(pca_res, choice = "var", axes = 1, top = 11) +
  labs(title = "Contributions √† l'axe 1")
p_contrib2 <- fviz_contrib(pca_res, choice = "var", axes = 2, top = 11) +
  labs(title = "Contributions √† l'axe 2")

print(p_contrib1 | p_contrib2)
```

### Tableau de corr√©lation PCA et clases CLC

```{r loadings_table, results='asis'}
# Charger les biblioth√®ques n√©cessaires
library(knitr)
library(kableExtra)
library(dplyr)
library(tibble)

# V√©rifier que pca_res existe et a la structure attendue
if (!exists("pca_res") || !("var" %in% names(pca_res)) || !("coord" %in% names(pca_res$var))) {
  stop("pca_res$var$coord n'existe pas. V√©rifiez votre objet PCA.")
}

# Pr√©paration des donn√©es
loadings <- as.data.frame(round(pca_res$var$coord[, 1:5], 3)) %>%
  rownames_to_column("Variable") # Ajoute les noms des variables comme colonne explicite

# Cr√©ation du tableau format√©
loadings %>%
  kable(
    caption = "üìä Corr√©lations entre les classes et les 5 premiers axes",
    col.names = c("Variable", "Axe 1", "Axe 2", "Axe 3", "Axe 4", "Axe 5"),
    digits = 3,
    align = c("l", rep("r", 5))
  ) %>%
  kable_styling(
    bootstrap_options = c("condensed", "striped", "hover"),
    full_width = TRUE,
    font_size = 12
  ) %>%
  row_spec(0, bold = TRUE, background = "#f0f0f0")

```

::: {.callout-tip title="Analyse des Axes de l'ACP (Occupation du Sol)"}

Les axes pr√©sent√©s correspondent √† des gradients d'occupation du sol
issus de l'Analyse en Composantes Principales (ACP). Chaque axe oppose
deux ensembles de milieux contrast√©s, interpr√©t√©s sur la base des
charges composantes associ√©es aux classes d'occupation du sol.

------------------------------------------------------------------------

**Axe 1 : Gradient Naturel/Bois√© vs Agricole/Cultiv√©**

+-----------------+-----------------------+-----------------------+
| Polarit√©        | Description           | Charges               |
|                 |                       | Significatives        |
+=================+=======================+=======================+
| **Positive      | Milieux **Naturels**  | A r bustive/herbac√©e  |
| (+)**           | et **Semi-Naturels**  |                       |
|                 | (Bois√©s)              | :   +0.63             |
|                 |                       |                       |
|                 |                       | For√™ts mixtes : +0.63 |
|                 |                       |                       |
|                 |                       | Z                     |
|                 |                       | ones humides c√¥ti√®res |
|                 |                       |                       |
|                 |                       | :   +0.29             |
+-----------------+-----------------------+-----------------------+
| **N√©gative      | Espaces **Agricoles   | Cultures : ‚àí0.527     |
| (‚àí)**           | Ouverts**             | Prairies : ‚àí0.30      |
+-----------------+-----------------------+-----------------------+

**Interpr√©tation :** Gradient le plus fort, opposant clairement
l'occupation du sol de type Naturel/Bois√© √† l'occupation de type
Agricole/Cultiv√©.

------------------------------------------------------------------------

**Axe 2 : Sp√©cificit√© Foresti√®re vs Agro-Artificiel**

Opposition Conif√®res/Feuillus vs Espaces Anthropis√©s

+-----------------+-----------------------+-----------------------+
| Polarit√©        | Description           | Charges               |
|                 |                       | Significatives        |
+=================+=======================+=======================+
| **N√©gative      | Milieux **Forestiers  | Conif√®res : ‚àí0.81     |
| (‚àí)**           | Stricts**             |                       |
|                 |                       | Feuillus : ‚àí0.55      |
+-----------------+-----------------------+-----------------------+
| **Positive      | Milieux **Agricoles** | Cultures : +0.51      |
| (+)**           | et **Artificialis√©s** |                       |
|                 |                       | Prairies : +0.43      |
|                 |                       |                       |
|                 |                       | Surfaces              |
|                 |                       | artificialis√©es :     |
|                 |                       | +0.29                 |
+-----------------+-----------------------+-----------------------+

**Interpr√©tation :** Oppose sp√©cifiquement les zones foresti√®res
(r√©sineux et feuillus) aux zones soumises √† l'activit√© humaine de type
Agricole et Urbain.

------------------------------------------------------------------------

**Axe 3 : Complexit√© Naturelle vs Artificialisation**

Milieux Naturels H√©t√©rog√®nes vs Impact Anthropique

+-----------------+-----------------------+-----------------------+
| Polarit√©        | Description           | Charges               |
|                 |                       | Significatives        |
+=================+=======================+=======================+
| **Positive      | Milieux **Naturels    | For√™ts mixtes : +0.43 |
| (+)**           | Complexes** et        |                       |
|                 | **H√©t√©rog√®nes**       | A r b ustive/herbac√©e |
|                 |                       |                       |
|                 |                       | :   +0.42             |
+-----------------+-----------------------+-----------------------+
| **N√©gative      | Surfaces √† **Impact   | Surfaces              |
| (‚àí)**           | Anthropique**         | artificialis√©es :     |
|                 |                       | ‚àí0.72                 |
|                 |                       |                       |
|                 |                       | Plans d'eau : ‚àí0.49   |
+-----------------+-----------------------+-----------------------+

**Interpr√©tation :** Oppose la complexit√© des milieux naturels
terrestres √† l'emprise humaine (artificialisation) et aux plans d'eau
(souvent anthropiques).

------------------------------------------------------------------------

**Axe 4 : Gradient Littoral**

Espaces Marins vs Milieux Humides Int√©rieurs

+-----------------+-----------------------+-----------------------+
| Polarit√©        | Description           | Charges               |
|                 |                       | Significatives        |
+=================+=======================+=======================+
| **Positive      | **Espaces Marins**    | Espaces marins :      |
| (+)**           |                       | +0.45                 |
|                 |                       |                       |
|                 |                       | Conif√®res : +0.32     |
+-----------------+-----------------------+-----------------------+
| **N√©gative      | Milieux **Ouverts**   | Prairies : ‚àí0.51      |
| (‚àí)**           | et **Humides**        |                       |
|                 |                       | Z ones humides        |
|                 |                       | c√¥ti√®res              |
|                 |                       |                       |
|                 |                       | : ‚àí0.41               |
+-----------------+-----------------------+-----------------------+

**Interpr√©tation :** Influenc√© par la distance √† la mer, il oppose les
Espaces Marins (et secondairement les conif√®res) √† certains milieux
ouverts et humides c√¥tiers.

------------------------------------------------------------------------

**Axe 5 : Maritimit√© vs Agriculture Int√©rieure**

Opposition Marine/Agricole

+-----------------+-----------------------+-----------------------+
| Polarit√©        | Description           | Charges               |
|                 |                       | Significatives        |
+=================+=======================+=======================+
| **Positive      | **Espaces Marins**    | Espaces marins        |
| (+)**           | (Exclusif)            |                       |
|                 |                       | :   +0.58             |
+-----------------+-----------------------+-----------------------+
| **N√©gative      | Milieux **Agricoles   | Prairies : ‚àí0.42      |
| (‚àí)**           | Ouverts** (Int√©rieur) |                       |
|                 |                       | Cultures : ‚àí0.42      |
+-----------------+-----------------------+-----------------------+

**Interpr√©tation :** Axe li√© √† la maritimit√©, opposant directement
l'environnement marin √† l'environnement agricole int√©rieur.

:::

```{r}
# Ajout des scores PCA aux signalements
signalements_pca <- bind_cols(
  signalements_clc,
  as.data.frame(pca_res$ind$coord[, 1:5]) %>%
    setNames(paste0("PCA", 1:5))
)
```

## Classification K-means

### D√©termination du nombre optimal de clusters

```{r kmeans-optimal, fig.width=12, fig.height=5}
# Donn√©es pour K-means
data_kmeans <- as.data.frame(pca_res$ind$coord[, 1:5])
colnames(data_kmeans) <- paste0("PCA", 1:5)

# M√©thode du coude
p_elbow <- fviz_nbclust(data_kmeans, kmeans, method = "wss", k.max = 10) +
  geom_vline(xintercept = 5, linetype = 2, color = "red") +
  labs(
    title = "M√©thode du coude",
    x = "Nombre de clusters (k)",
    y = "Somme des carr√©s intra-cluster"
  ) +
  theme_minimal()

print(p_elbow)
```

### Application du K-means

```{r kmeans-apply}
# Application du K-means (k = 5)
set.seed(1234)
k_opt <- 5
km_res <- kmeans(data_kmeans, centers = k_opt, nstart = 25)

# Ajout des clusters aux donn√©es
signalements_km <- signalements_pca
signalements_km$cluster <- factor(km_res$cluster)

cat("üéØ Classification r√©alis√©e en", k_opt, "groupes\n")
cat("üìä R√©partition des signalements par cluster:\n")

print(table(signalements_km$cluster))

cat("\nüíØ Qualit√© du clustering (between_SS / total_SS):",
    round(km_res$betweenss / km_res$totss * 100, 2), "%\n")
```

::: {.callout-tip title="Qualit√© de la classification"}

üìê La M√©trique : Between_SS / Total_SS Formule : (Between_SS / Total_SS) √ó 100

Total_SS = Variance totale des donn√©es (100%)

Between_SS = Variance entre les clusters (s√©paration)

Principe : Plus les clusters sont √©loign√©s les uns des autres et
compacts, plus le score est √©lev√©.

üìä Signification de 54.29% de la variance expliqu√©e par la s√©paration
entre clusters

‚ö†Ô∏è 45.71% de la variance due √† la dispersion interne (Within_SS)

‚úÖ Points Positifs : Structure r√©elle d√©tect√©e dans les donn√©es Clusters
diff√©renci√©s (pas al√©atoire) Score normal pour des signalements (donn√©es
complexes)

‚ö†Ô∏è Limites : 45% de variance reste inexpliqu√©e donc des Clusters pas
parfaitement s√©par√©s Possibilit√© d'am√©lioration

‚úÖ Conclusion pour des signalements, 54.29% est acceptable mais pas
optimal. L'important est de v√©rifier que vos 5 groupes ont une
interpr√©tation coh√©rente au-del√† du chiffre statistique.

√âchelle : \< 40% (faible) \| 40-60% (moyen) \| 60-80% (bon) \| \> 80%
(excellent). 
:::

### Statistiques descriptives par cluster

```{r kmeans-stats}
library(knitr)
library(kableExtra)
library(dplyr)

# 1. Pr√©paration des donn√©es
signalements_km_summary_t <- signalements_km %>%
  st_drop_geometry() %>%
  select(cluster, starts_with("class_")) %>%
  group_by(cluster) %>%
  summarise(across(starts_with("class_"), mean), .groups = "drop") %>%
  # On s'assure que les colonnes class_1, class_2... sont dans le bon ordre
  select(cluster, paste0("class_", 1:length(clc_labels))) %>% 
  mutate(cluster = paste0("Cluster ", cluster)) %>%
  tibble::column_to_rownames("cluster") %>%
  `colnames<-`(clc_labels) %>%
  t() %>%
  as.data.frame() %>%
  tibble::rownames_to_column("Type d'occupation du sol")

# 2. Mise en forme avec kableExtra
signalements_km_summary_t %>%
  kable(
    digits = 1,
    format = "html", 
    caption = "Pourcentage moyen de chaque classe CLC+ par cluster",
    col.names = c("Type d'occupation du sol", colnames(signalements_km_summary_t)[-1])
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    position = "left"
  ) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>% # Met la 1√®re colonne en gras
  row_spec(0, bold = TRUE, background = "#f2f2f2")     # En-t√™te grise et gras
```

::: {.callout-tip title="Typologie paysag√®re identifi√©e"}
**Cluster 1 ‚Äì Pyasages forestiers**

-   Conif√®res tr√®s majoritaires (51,3 %),

-   avec une part notable de feuillus (19,5 %) et de prairies (16,3 %).

-   Tr√®s peu de surfaces artificialis√©es.

-   üëâ **Profil** : territoires majoritairement forestiers, plut√¥t
    naturels ou semi-naturels, typiques de zones montagnardes ou peu
    anthropis√©es.

**Cluster 2 ‚Äì Territoires agricoles-prairies**

-   Cultures dominantes (44,0 %) et prairies importantes (22,0 %).

-   Pr√©sence secondaire de conif√®res (21,8 %) et Artificialisation
    faible.

-   üëâ **Profil** : paysages agro-pastoraux, √† vocation agricole
    marqu√©e, avec une mosa√Øque cultures‚Äìprairies‚Äìfor√™ts.

**Cluster 3 ‚Äì Milieux ouverts semi-naturels**

-   Forte proportion de formations arbustives/herbac√©es (26,8 %).

-   Parts √©quilibr√©es de prairiesn(20,4 %), conif√®res (14,0 %) et
    surfaces artificielles (15,7 %).

-   üëâ **Profil :** territoires de transition, combinant espaces
    naturels ouverts, activit√©s humaines et urbanisation mod√©r√©e (zones
    p√©riurbaines, friches, garrigues, landes).

**Cluster 4 ‚Äì Espaces fortement urbanis√©s**

-   Surfaces artificialis√©es tr√®s dominantes (47,3 %).

-   Compl√©ments de prairies (18,6 %), conif√®res (20,5 %) et plans d‚Äôeau
    (4,5 %).

-   üëâ **Profil :** zones urbaines et p√©riurbaines et quelques espaces
    verts ou naturels r√©siduels.

**Cluster 5 ‚Äì Paysages prairiaux et ruraux**

-   Prairies tr√®s majoritaires (46,5 %).

-   Parts secondaires de conif√®res (22,7 %), cultures (12,8 %) et
    surfaces artificielles mod√©r√©es.

-   üëâ **Profil :** territoires ruraux extensifs, souvent li√©s √†
    l‚Äô√©levage, avec une anthropisation faible √† mod√©r√©e.
:::

## Cartographie de l'environnement de piq√ªre

**Remplissage label selon les clusters**

```{r}
labels_carte <- c(
  "C1 : Paysages √† dominance foresti√®re",
  "C2 : Territoires agricols intensifs",
  "C3 : Milieux mixtes semi-naturels",
  "C4 : Espaces urbains et p√©riurbains",
  "C5 : Paysages mixtes avec prairies naturelles"
)

signalements_km$label <- labels_carte[signalements_km$cluster]

```


**R√©partition par profil paysager**

```{r}

library(leaflet)
library(sf)
library(dplyr)

# Reprojection en WGS84
signalements_wgs84 <- st_transform(signalements_km, crs = 4326)

# Extraction des coordonn√©es
coords <- st_coordinates(signalements_wgs84)
signalements_wgs84$lon <- coords[, 1]
signalements_wgs84$lat <- coords[, 2]

# S'assurer que label est un facteur
signalements_wgs84$label <- as.factor(signalements_wgs84$label)

# Palette de couleurs par label
couleurs <- couleurs <- c(
  "#2E8B57",  
  "#FFD700",  
  "#A8DADC", 
  "#E63946",
  "#7FB800"
)

pal <- colorFactor(
  palette = couleurs,
  domain  = levels(signalements_wgs84$label)
)

# Cr√©ation de la carte Leaflet
leaflet_map <- leaflet(signalements_wgs84) %>%

  # Fonds de carte
  addProviderTiles(
    providers$CartoDB.Positron,
    group = "Fond clair"
  ) %>%

  addProviderTiles(
    providers$OpenStreetMap,
    group = "OpenStreetMap"
  ) %>%

  addProviderTiles(
    providers$Esri.WorldImagery,
    group = "Satellite"
  ) %>%

  # Points cat√©goris√©s par label
  addCircleMarkers(
    lng = ~lon,
    lat = ~lat,
    radius = 6,
    fillColor = ~pal(label),
    fillOpacity = 0.9,
    color = "grey20",
    weight = 1,
    stroke = TRUE,
    popup = ~paste0(
      "<b>Label : ", label, "</b><br>",
      "Coordonn√©es : ", round(lon, 4), ", ", round(lat, 4)
    )
  ) %>%

  # L√©gende
  addLegend(
    position = "bottomright",
    pal = pal,
    values = ~label,
    title = "L√©gende",
    opacity = 1
  ) %>%

  # Contr√¥le des fonds de carte
  addLayersControl(
    position = "bottomright",
    baseGroups = c("OpenStreetMap", "Satellite"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>%

  # Titre
  addControl(
    html = "
      <div style='background:white; padding:6px; border-radius:5px;'>
        <h4 style='margin:0;'>Typologie paysag√®re des signalements</h4>
        <p style='margin:0; font-size:12px;'>
          pour le piq√ªre de tique sur les chiens
        </p>
      </div>",
    position = "topright"
  )

# Affichage
leaflet_map

```

**Visualisation dans l'espace PCA**

```{r kmeans-biplot}
p_km_biplot <- fviz_cluster(
  km_res,
  data = data_kmeans,
  geom = "point",
  ellipse.type = "norm",
  palette = c("#dbffe2", "#FF0014", "#F9FF00", "#18a843", "#095FF1"),
  ggtheme = theme_minimal(),
  main = "Clusters dans l'espace PCA (axes 1-2)"
)

print(p_km_biplot)
```

## Synth√®se des typologies paysag√®res

```{r synthesis, message=FALSE, warning=FALSE}
library(dplyr)
library(sf)
library(knitr)
library(kableExtra)

summary_clusters <- signalements_km %>%
  st_drop_geometry() %>%
  group_by(cluster) %>%
  summarise(
    `N` = n(),
    `Urbain (%)` = mean(class_1, na.rm = TRUE),
    `For√™t (%)` = mean(class_2 + class_3 + class_4, na.rm = TRUE),
    `Agriculture (%)` = mean(class_7, na.rm = TRUE),
    `Prairie (%)` = mean(class_6, na.rm = TRUE),
    .groups = "drop"
  )

summary_clusters %>%
  kable(
    digits = 1,
    caption = "Synth√®se des typologies paysag√®res par cluster",
    booktabs = TRUE,
    align = "c"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    position = "center"
  ) %>%
  row_spec(0, bold = TRUE) %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, background = "#F7F7F7") %>%
  column_spec(3:6, width = "8em")

```

**R√©partition des signalements par envionnement de piq√ªre**

```{r}
library(dplyr)
library(ggplot2)

signalements_km %>%
  count(label) %>%
  mutate(
    pourcentage = n / sum(n) * 100,
    label_pct = paste0(round(pourcentage, 1), "%")
  ) %>%
  ggplot(aes(x = 2, y = n, fill = label)) +
  geom_col(width = 1, color = "white") +
  coord_polar("y") +
  xlim(0.5, 2.5) +
  geom_text(
    aes(label = label_pct),
    position = position_stack(vjust = 0.5),
    size = 4
  ) +
  scale_fill_manual(
    values = c(
      "#2E8B57",  
      "#FFD700",  
      "#A8DADC", 
      "#E63946",
      "#7FB800"
    )
  ) +
  labs(
    title = "Taux de r√©partition des signalements",
    fill = "Paysages de signalements"
  ) +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12)
  )


```
**R√©partition de signalement selon paysage d√©clar√© et profils analys√©s**

```{r}
library(ggplot2)
library(dplyr)
library(sf)

# Pr√©parer les donn√©es
df <- signalements_km %>%
  st_drop_geometry() %>%
  count(cluster, environ)

# Graphique √† barres empil√©es
ggplot(df, aes(x = cluster, y = n, fill = environ)) +
  geom_bar(stat = "identity") +        # barres empil√©es
  labs(
    #title = "Nombre de signalements par paysage et environnement d√©clar√©",
    x = "Cluster",
    y = "Nombre de signalements",
    fill = "Environnement"
  ) +
  theme_minimal() +                   # th√®me √©pur√©
  theme(
    axis.text.x = element_text(angle = 0, hjust = 1)  # rotation labels x si besoin
  )

```
**signalements par r√©gion et environnement analys√©**

```{r}
library(ggplot2)
library(dplyr)
library(sf)

# Pr√©parer les donn√©es
library(ggplot2)
library(dplyr)
library(sf)

# Palette personnalis√©e
palette_label <- c(
  "#2E8B57",  
  "#FFD700",  
  "#A8DADC", 
  "#E63946",
  "#7FB800"
)

# Pr√©parer les donn√©es
df <- signalements_km %>%
  st_drop_geometry() %>%
  count(region, label)

# Graphique √† barres empil√©es
ggplot(df, aes(x = region, y = n, fill = label)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = palette_label) +   # üé® palette appliqu√©e
  labs(
    x = "R√©gion",
    y = "Nombre de signalements",
    fill = "profil de signalement"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )


```

------------------------------------------------------------------------------

# Export des donn√©es

```{r export, eval=FALSE}
# Export du shapefile avec clusters
st_write(
  signalements_km,
  "C:/Users/geographie/Documents/Master-G2M/M2-G2M/Ptut_VG_B/processing/outputs/signalements_typologie_paysagere.shp",
  delete_dsn = TRUE,
  quiet = TRUE
)

```


